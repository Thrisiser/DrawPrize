<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¸­è¯é›»ä¿¡å­¸é™¢å¹´çµ‚æ„Ÿæ©é¤æœƒ-å¯¦é«”æŠ½çå¾Œæ‰‹å‹•ç™»è¨˜é¡¯ç¤ºå¾—çè€…è³‡è¨Š</title>

  <!-- âœ… favicon -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect x='6' y='6' width='52' height='52' rx='12' fill='%230e0f14' stroke='%23f1d28a' stroke-width='4'/%3E%3Cg fill='%23f1d28a'%3E%3Ccircle cx='24' cy='24' r='4'/%3E%3Ccircle cx='40' cy='40' r='4'/%3E%3Ccircle cx='24' cy='40' r='4'/%3E%3Ccircle cx='40' cy='24' r='4'/%3E%3C/g%3E%3C/svg%3E" />

  <style>
    :root{
      --bg:#0b1020; --panel:#121a33; --panel2:#0f1730; --text:#e9eefc; --muted:#a9b4d6;
      --accent:#6aa6ff; --ok:#46d39a; --warn:#ffcf5a; --bad:#ff6a6a; --line:#26325d;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans TC", Arial, sans-serif;
      background: linear-gradient(160deg, #070a14, var(--bg));
      color:var(--text);
    }
    a{ color:var(--accent); }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    .grid{ display:grid; grid-template-columns: 1.2fr 1fr; gap:14px; align-items:start; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    h1,h2{ margin:0 0 10px 0; }
    h1{ font-size:20px; }
    h2{ font-size:16px; color:var(--muted); font-weight:650; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex: 0 0 auto; }
    label{ font-size:13px; color:var(--muted); display:block; margin:8px 0 6px; }
    input[type="text"], textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:88px; resize:vertical; }
    button{
      border:1px solid var(--line);
      background: rgba(106,166,255,.15);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
    }
    button:hover{ background: rgba(106,166,255,.22); }
    button.ok{ background: rgba(70,211,154,.18); }
    button.ok:hover{ background: rgba(70,211,154,.25); }
    button.bad{ background: rgba(255,106,106,.14); }
    button.bad:hover{ background: rgba(255,106,106,.20); }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.5; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:3px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--muted); font-size:12px;
    }
    .pill strong{ color:var(--text); font-weight:750; }
    .small{ 
	font-size:26px; color:var(--muted); 
	text-shadow:
        0 2px 0 rgba(0,0,0,.55),
        0 12px 30px rgba(0,0,0,.55),
        0 0 18px rgba(241,210,138,.18);
	background: linear-gradient(180deg,
    #fff2c7 0%,
    #f7d88b 18%,
    #e9be59 40%,
    #fff1c2 58%,
    #c9972b 78%,
    #fff0b8 100%
  );
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
	}
    table{ width:100%; border-collapse:collapse; }
    th,td{ border-bottom:1px solid rgba(38,50,93,.7); padding:8px 6px; vertical-align:top; }
    th{ text-align:left; font-size:12px; color:var(--muted); font-weight:750; }
    td{ font-size:13px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .right{ text-align:right; }
    .divider{ height:1px; background: rgba(38,50,93,.8); margin:12px 0; }
    .warnbox{
      border:1px dashed rgba(255,207,90,.6);
      background: rgba(255,207,90,.08);
      padding:10px 12px;
      border-radius:12px;
      color: var(--muted);
      font-size:12px;
      line-height:1.5;
    }

    /* =======================
       Stage view (èˆå°ç•«é¢)
       ======================= */

    .stage{
      height: 100vh;
      width: 100vw;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      margin:0;
    }

    .stageCard{
      width: 100vw;
      height: 100vh;
      border-radius: 0;
      border: 0;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(106,166,255,.18), transparent 60%),
        radial-gradient(900px 500px at 80% 30%, rgba(70,211,154,.12), transparent 55%),
        radial-gradient(800px 420px at 55% 90%, rgba(255,220,150,.10), transparent 60%),
        rgba(0,0,0,.32);
      box-shadow: none;

      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;

      padding: clamp(12px, 2.0vh, 28px) clamp(12px, 2.2vw, 34px);
      text-align:center;
      position:relative;
      overflow:hidden;
    }

    .stageTop{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:16px;
      flex-wrap:wrap;
      margin-top: clamp(35px, 50px, 50px);
	  margin-bottom: clamp(20px, 25px, 25px);
    }

    .stageTitle{
      margin:0;
      font-size: clamp(60px, 4.0vmin, 100px);
      font-weight: 1000;
      letter-spacing: 1.03px;
      line-height: 1.10;
      position: relative;
      padding-right: 3px;
      min-width: 0;

      background: linear-gradient(180deg,
        #fff2c7 0%,
        #f7d88b 18%,
        #e9be59 40%,
        #fff1c2 58%,
        #c9972b 78%,
        #fff0b8 100%
      );
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;

      text-shadow:
        0 2px 0 rgba(0,0,0,.55),
        0 12px 30px rgba(0,0,0,.55),
        0 0 18px rgba(241,210,138,.18);
    }

    .stageTitle::after{
      content:"";
      position:absolute;
      inset:-18% -30%;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255,255,255,.35) 45%,
        rgba(255,255,255,.10) 55%,
        transparent 100%
      );
      transform: rotate(12deg) translateX(-60%);
      animation: titleShimmer 3.2s linear infinite;
      mix-blend-mode: screen;
      pointer-events:none;
    }

    @keyframes titleShimmer{
      0%   { transform: rotate(12deg) translateX(-60%); opacity: .0; }
      12%  { opacity: .65; }
      35%  { opacity: .25; }
      100% { transform: rotate(12deg) translateX(60%); opacity: 0; }
    }

    /* âœ… çé …/å…§å®¹åˆ†æ¬„é¡¯ç¤ºï¼šå¤–å±¤å®¹å™¨ */
    .bigPrizeWrap{
      margin-top: clamp(10px, 2.0vh, 26px);
      position: relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: clamp(6px, 1.2vh, 14px);
    }

    /* âœ… ç¬¬ä¸€è¡Œï¼šçé …ï¼ˆå¤§å­—ï¼‰ */
    .bigPrizeTitle{
      font-size: clamp(80px, 8.0vmin, 160px);
      font-weight: 1000;
      letter-spacing: .08em;
      line-height: 1.10;

      background: linear-gradient(180deg,
        #fff2c7 0%,
        #f7d88b 18%,
        #e9be59 40%,
        #fff1c2 58%,
        #c9972b 78%,
        #fff0b8 100%
      );
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;

      text-shadow:
        0 3px 0 rgba(0,0,0,.55),
        0 18px 36px rgba(0,0,0,.55),
        0 0 22px rgba(241,210,138,.35);

      animation: prizeGlow 3.5s ease-in-out infinite alternate;
      position:relative;
    }

    /* âœ… ç¬¬äºŒè¡Œï¼šå…§å®¹ï¼ˆç´„ 80% å¤§å°ï¼‰ */
    .bigPrizeDesc{
      font-size: clamp(70px, 6vmin, 100px);
      font-weight: 900;
      letter-spacing: .06em;
      line-height: 1.12;

      background: linear-gradient(180deg,
        #fff2c7 0%,
        #f7d88b 18%,
        #e9be59 40%,
        #fff1c2 58%,
        #c9972b 78%,
        #fff0b8 100%
      );
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;

      text-shadow:
        0 2px 0 rgba(0,0,0,.55),
        0 14px 30px rgba(0,0,0,.55),
        0 0 18px rgba(241,210,138,.28);

      position:relative;
      opacity: .98;
    }

    @keyframes prizeGlow{
      0%   { filter: brightness(1); }
      100% { filter: brightness(1.15); }
    }

    /* äº®å…‰æƒéï¼šåœ¨å¤–å±¤åšä¸€æ¬¡å°±å¥½ */
    .bigPrizeWrap::after{
      content:"";
      position:absolute;
      inset:-20% -40%;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255,255,255,.45) 45%,
        rgba(255,255,255,.15) 55%,
        transparent 100%
      );
      transform: rotate(12deg) translateX(-70%);
      animation: prizeShimmer 4.2s linear infinite;
      mix-blend-mode: screen;
      pointer-events:none;
    }

    @keyframes prizeShimmer{
      0%   { transform: rotate(12deg) translateX(-70%); opacity: 0; }
      15%  { opacity: .8; }
      35%  { opacity: .25; }
      100% { transform: rotate(12deg) translateX(70%); opacity: 0; }
    }

    .bigWinners{
      margin-top: clamp(14px, 3.0vh, 34px);
      display:flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: clamp(12px, 1.8vh, 24px);
      line-height:1.20;
      font-weight: 800;

      flex: 1 1 auto;
      align-content: center;
      width: 100%;
      padding: 0 clamp(8px, 2vw, 24px) clamp(10px, 2vh, 22px);
    }

    .wItem{
      display:inline-flex;
      align-items:center;
      gap: 14px;

      min-width: min(280px, 92vw);

      padding: clamp(14px, 2.0vh, 22px) clamp(18px, 2.2vw, 28px);
      border-radius: 22px;

      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.25)),
        rgba(0,0,0,.35);

      border: 1px solid rgba(255,215,140,.45);

      box-shadow:
        0 18px 40px rgba(0,0,0,.6),
        inset 0 0 18px rgba(255,220,150,.18);
    }

    .winnerId{
      display:inline-block;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: clamp(18px, 2.6vmin, 34px);
      font-weight: 900;

      background: linear-gradient(180deg,#fff6cf,#e3b44a);
      color: #3b2a00;

      box-shadow:
        0 4px 10px rgba(0,0,0,.45),
        inset 0 0 6px rgba(255,255,255,.5);
    }

    .winnerName{
      font-size: clamp(30px, 4.2vmin, 64px);
      font-weight: 900;
      letter-spacing: .12em;
      color: #fff;

      text-shadow:
        0 2px 0 rgba(0,0,0,.55),
        0 10px 22px rgba(0,0,0,.6),
        0 0 16px rgba(255,220,150,.25);
    }

    .stageFlash{
      position:absolute;
      inset:-30%;
      pointer-events:none;
      opacity:0;
      background:
        radial-gradient(closest-side at 50% 40%, rgba(255,245,210,.85), transparent 55%),
        radial-gradient(closest-side at 30% 25%, rgba(255,230,150,.55), transparent 60%),
        radial-gradient(closest-side at 70% 30%, rgba(255,255,255,.35), transparent 65%);
      mix-blend-mode: screen;
      filter: blur(1px);
    }

    .stageFlash.boom{
      animation: flashBoom 900ms ease-out both;
    }

    @keyframes flashBoom{
      0%   { opacity: 0; transform: scale(.92); filter: blur(2px) brightness(.9); }
      10%  { opacity: 1; }
      35%  { opacity: .88; transform: scale(1.02); filter: blur(1px) brightness(1.35); }
      100% { opacity: 0; transform: scale(1.10); filter: blur(3px) brightness(1.05); }
    }

    .winnerCard{ opacity:0; transform: translateY(14px) scale(.98); }
    .winnerCard.reveal{ animation: winnerReveal 650ms cubic-bezier(.2,.9,.2,1) both; }

    @keyframes winnerReveal{
      0%   { opacity:0; transform: translateY(18px) scale(.98); filter: blur(2px); }
      60%  { opacity:1; transform: translateY(-2px) scale(1.01); filter: blur(0px); }
      100% { opacity:1; transform: translateY(0) scale(1); }
    }

    /* âœ… å³ä¸Šè§’å°å–‡å­æŒ‰éˆ•ï¼ˆé è¨­æœ‰è²ï¼ŒæŒ‰ä¸‹è®ŠéœéŸ³ï¼‰ */
    .audioToggle{
      position:absolute;
      right: 18px;
      top: 18px;
      z-index: 6;
      display: inline-flex;
    }
    .audioToggle button{
      border: 1px solid rgba(255,215,140,.55);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor: pointer;
      user-select: none;
    }
    .audioToggle button:hover{
      background: rgba(0,0,0,.45);
    }
  </style>
</head>
<body>
<div id="app"></div>

<script>
(() => {
  const isStage = new URLSearchParams(location.search).get("stage") === "1";

  // --- Storage keys
  const KEY = {
    participants: "manual_award.participants.v1",
    prizes:       "manual_award.prizes.v1",
    history:      "manual_award.history.v1",
    stageState:   "manual_award.stageState.v1",
    audioMuted:   "manual_award.audioMuted.v1",
  };

  // --- Cross-window realtime sync
  const bc = ("BroadcastChannel" in window) ? new BroadcastChannel("manual_award_channel_v1") : null;
  const post = (type, payload) => {
    const msg = { type, payload, at: Date.now() };
    if (bc) bc.postMessage(msg);
    localStorage.setItem("__manual_award_ping__", JSON.stringify(msg));
    localStorage.removeItem("__manual_award_ping__");
  };

  const loadJSON = (k, fallback) => {
    try { const s = localStorage.getItem(k); return s ? JSON.parse(s) : fallback; }
    catch { return fallback; }
  };
  const saveJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  // --- CSV helpers
  const splitCSVLine = (line) => {
    const out = [];
    let cur = "", inQ = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"') {
        if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === "," && !inQ) {
        out.push(cur.trim());
        cur = "";
      } else {
        cur += ch;
      }
    }
    out.push(cur.trim());
    return out;
  };

  const parseCSV = (text) => {
    const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n")
      .map(x => x.trim()).filter(x => x.length && !x.startsWith("#"));
    if (!lines.length) return { header: [], rows: [] };
    const header = splitCSVLine(lines[0]).map(h => h.replace(/^"|"$/g,""));
    const rows = lines.slice(1).map(line => splitCSVLine(line).map(v => v.replace(/^"|"$/g,"")));
    return { header, rows };
  };

  const downloadText = (filename, text) => {
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(a.href);
      a.remove();
    }, 0);
  };

  // --- Utils
  const normalize = (s) => (s ?? "").toString().trim();
  const padId = (s) => normalize(s) ? normalize(s) : "";

  // âœ… æŠŠ prize å­—ä¸²æ‹†æˆ {title, desc}
  // - æ”¯æ´ "æ¨™é¡Œ\nå…§å®¹"
  // - æ”¯æ´ "æ¨™é¡Œï½œå…§å®¹" / "æ¨™é¡Œ|å…§å®¹"ï¼ˆä¿éšªï¼‰
  const splitPrize = (prizeRaw) => {
    const raw = (prizeRaw ?? "").toString();
    const s = raw.replace(/\r\n/g,"\n").replace(/\r/g,"\n");

    // å„ªå…ˆç”¨æ›è¡Œæ‹†
    if (s.includes("\n")){
      const [t, ...rest] = s.split("\n");
      const title = normalize(t);
      const desc = normalize(rest.join("\n"));
      return { title: title || "ç­‰å¾…å…¬å¸ƒâ€¦", desc };
    }

    // å…¶æ¬¡ç”¨åˆ†éš”ç¬¦æ‹†
    const m = s.match(/^(.*?)\s*(?:\||ï½œ)\s*(.+)$/);
    if (m){
      const title = normalize(m[1]);
      const desc = normalize(m[2]);
      return { title: title || "ç­‰å¾…å…¬å¸ƒâ€¦", desc };
    }

    return { title: normalize(s) || "ç­‰å¾…å…¬å¸ƒâ€¦", desc: "" };
  };

  const buildIndex = (participants) => {
    const byId = new Map();
    const byName = new Map();
    const all = [];
    for (const p of participants){
      const id = padId(p.id);
      const name = normalize(p.name);
      if (!name && !id) continue;
      const obj = { id, name };
      all.push(obj);
      if (id) byId.set(id, obj);
      if (name){
        if (!byName.has(name)) byName.set(name, []);
        byName.get(name).push(obj);
      }
    }
    return { byId, byName, all };
  };

  const resolveToken = (token) => {
    token = normalize(token);
    if (!token) return { ok:false, raw:"", reason:"ç©ºç™½" };

    const isId = /^[0-9]+$/.test(token);
    if (isId){
      const found = state.index.byId.get(token);
      if (found) return { ok:true, id: found.id, name: found.name, raw: token };

      const num = String(parseInt(token,10));
      for (const [k,v] of state.index.byId.entries()){
        if (/^[0-9]+$/.test(k) && String(parseInt(k,10)) === num){
          return { ok:true, id: v.id, name: v.name, raw: token, note:`ä»¥ ${v.id} é…å°` };
        }
      }
      return { ok:false, raw: token, reason:"æ‰¾ä¸åˆ°æ­¤åºè™Ÿ" };
    }

    const exact = state.index.byName.get(token);
    if (exact && exact.length === 1){
      return { ok:true, id: exact[0].id, name: exact[0].name, raw: token };
    }
    if (exact && exact.length > 1){
      return { ok:true, id: exact[0].id, name: exact[0].name, raw: token, note:`åŒå ${exact.length} äººï¼Œå·²å–ç¬¬ä¸€ç­†` };
    }

    const hits = state.index.all.filter(p => p.name && p.name.includes(token));
    if (hits.length === 1){
      return { ok:true, id: hits[0].id, name: hits[0].name, raw: token, note:"ä»¥éƒ¨åˆ†å§“åé…å°" };
    }
    if (hits.length > 1){
      return { ok:false, raw: token, reason:`éƒ¨åˆ†å§“åå‘½ä¸­ ${hits.length} äººï¼ˆè«‹è¼¸å…¥æ›´å®Œæ•´ï¼‰` };
    }
    return { ok:false, raw: token, reason:"æ‰¾ä¸åˆ°æ­¤å§“å" };
  };

  // --- State
  const state = {
    participants: loadJSON(KEY.participants, []),
    prizes: loadJSON(KEY.prizes, []),
    history: loadJSON(KEY.history, []),
    stageState: loadJSON(KEY.stageState, { prize: "", winners: [], updatedAt: 0 }),
    index: null,
    uiSelectedPrize: loadJSON("manual_award.uiSelectedPrize.v1", ""),
    audioMuted: loadJSON(KEY.audioMuted, false),
  };
  state.index = buildIndex(state.participants);

  const saveAll = () => {
    saveJSON(KEY.participants, state.participants);
    saveJSON(KEY.prizes, state.prizes);
    saveJSON(KEY.history, state.history);
    saveJSON(KEY.stageState, state.stageState);
    saveJSON("manual_award.uiSelectedPrize.v1", state.uiSelectedPrize);
    saveJSON(KEY.audioMuted, state.audioMuted);
  };

  // --- UI helper
  const el = (tag, attrs={}, ...children) => {
    const node = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)){
      if (k === "class") node.className = v;
      else if (k === "html") node.innerHTML = v;
      else if (k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2), v);
      else if (v !== null && v !== undefined) node.setAttribute(k, v);
    }
    for (const c of children){
      if (c === null || c === undefined) continue;
      node.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
    }
    return node;
  };

  const fmtTime = (ts) => {
    const d = new Date(ts);
    const pad = (n) => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  };

  const escapeCSV = (s) => {
    s = (s ?? "").toString();
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  };

  /* =======================
     Stage view
     ======================= */
  let stageUI = null;
  let lastAnnouncedAt = 0;

  let stageRenderedPrize = "";
  let stageRenderedCount = 0;
  let stageRenderedKeys = [];

  let playingPrize = "";
  let audioLoopBound = false;
  let audioStartedForCurrentPrize = false; // âœ… æœ¬çé …æ˜¯å¦å·²ç”±ç¬¬ä¸€ä½å¾—çè€…å•Ÿå‹•éŸ³æ•ˆ

  const AUDIO_START_SEC = 0;
  const AUDIO_PLAY_SEC  = 116;

  const stopAudio = () => {
    if (!stageUI?.audio) return;
    const a = stageUI.audio;
    try{
      a.pause();
      a.currentTime = Math.max(0, AUDIO_START_SEC);
    }catch{}
  };

  const startLoopAudio = async () => {
    if (!stageUI?.audio) return;
    if (state.audioMuted) return;

    const a = stageUI.audio;
    a.muted = !!state.audioMuted;

    const start = Math.max(0, AUDIO_START_SEC);
    const end   = Math.max(start + 0.1, start + AUDIO_PLAY_SEC);

    if (!audioLoopBound){
      a.addEventListener("timeupdate", () => {
        if (a.currentTime >= (end - 0.05)){
          a.currentTime = start;
        }
      });
      a.addEventListener("ended", () => {
        a.currentTime = start;
        if (!a.muted){
          a.play().catch(() => {});
        }
      });
      audioLoopBound = true;
    }

    if (Math.abs(a.currentTime - start) > 0.2 && (a.currentTime < start || a.currentTime > end)){
      a.currentTime = start;
    }

    try{
      await a.play();
      return true;
    }catch{
      return false;
    }
  };

  const updateAudioBtn = () => {
    if (!stageUI?.audioBtn) return;
    stageUI.audioBtn.textContent = state.audioMuted ? "ğŸ”‡" : "ğŸ”Š";
    stageUI.audioBtn.title = state.audioMuted ? "ç›®å‰éœéŸ³ï¼ˆé»ä¸€ä¸‹é–‹å•ŸéŸ³æ•ˆï¼‰" : "éŸ³æ•ˆé–‹å•Ÿï¼ˆé»ä¸€ä¸‹éœéŸ³ï¼‰";
    stageUI.audioBtn.setAttribute("aria-pressed", state.audioMuted ? "true" : "false");
  };

  const toggleMute = async () => {
    state.audioMuted = !state.audioMuted;
    saveAll();

    if (stageUI?.audio){
      stageUI.audio.muted = !!state.audioMuted;
    }

    if (state.audioMuted){
      stopAudio();
    } else {
      await startLoopAudio();
    }
    updateAudioBtn();
  };

  const boomFlash = () => {
    if (!stageUI?.flash) return;
    stageUI.flash.classList.remove("boom");
    void stageUI.flash.offsetWidth;
    stageUI.flash.classList.add("boom");
  };

  const makeWinnerItem = (w, animate=false) => {
    const item = el("span", { class: "wItem winnerCard" },
      el("span", { class:"mono winnerId" }, w.id ? w.id : "--"),
      el("span", { class:"winnerName" }, w.name ? w.name : "(æœªå‘½å)")
    );
    if (!animate) item.classList.add("reveal");
    else setTimeout(() => item.classList.add("reveal"), 0);
    return item;
  };

  const syncStageWinnersIncremental = (st) => {
    const list = Array.isArray(st.winners) ? st.winners : [];
    const prize = st.prize || "";

    const keyOf = (w) => `${w?.id || ""}||${w?.name || ""}`;
    const keys = list.map(keyOf);

    const needRebuild =
      prize !== stageRenderedPrize ||
      list.length < stageRenderedCount ||
      stageRenderedKeys.some((k, i) => keys[i] !== k);

    if (needRebuild){
      stageUI.winners.innerHTML = "";
      if (!list.length){
        stageUI.winners.appendChild(el("div", { class:"small" }, "å³å°‡æŠ½å‡ºçé … æ•¬è«‹æœŸå¾…"));
        stageRenderedPrize = prize;
        stageRenderedCount = 0;
        stageRenderedKeys = [];
        return;
      }
      list.forEach(w => stageUI.winners.appendChild(makeWinnerItem(w, false)));
      stageRenderedPrize = prize;
      stageRenderedCount = list.length;
      stageRenderedKeys = keys.slice();
      return;
    }

    if (list.length === stageRenderedCount + 1){
      const wNew = list[list.length - 1];
      const firstChild = stageUI.winners.firstChild;
      if (firstChild && firstChild.classList && firstChild.classList.contains("small")){
        stageUI.winners.innerHTML = "";
      }
      stageUI.winners.appendChild(makeWinnerItem(wNew, true));
      stageRenderedCount = list.length;
      stageRenderedKeys = keys.slice();
      return;
    }

    stageUI.winners.innerHTML = "";
    if (!list.length){
      stageUI.winners.appendChild(el("div", { class:"small" }, "å³å°‡æŠ½å‡ºçé … æ•¬è«‹æœŸå¾…"));
      stageRenderedPrize = prize;
      stageRenderedCount = 0;
      stageRenderedKeys = [];
      return;
    }
    list.forEach(w => stageUI.winners.appendChild(makeWinnerItem(w, false)));
    stageRenderedPrize = prize;
    stageRenderedCount = list.length;
    stageRenderedKeys = keys.slice();
  };

  const setStagePrize = (prizeRaw) => {
    const { title, desc } = splitPrize(prizeRaw);
    stageUI.prizeTitle.textContent = title || "ç­‰å¾…å…¬å¸ƒâ€¦";
    stageUI.prizeDesc.textContent = desc || "";
    stageUI.prizeDesc.style.display = desc ? "" : "none";
  };

  const announceStageAnimated = async (st) => {
    if (!stageUI) return;
    if (!st?.updatedAt || st.updatedAt <= lastAnnouncedAt) return;
    lastAnnouncedAt = st.updatedAt;

    boomFlash();

    // âœ… æ›´æ–°çé …/å…§å®¹
    setStagePrize(st.prize || "");

    // âœ… éŸ³æ•ˆï¼šåˆ‡æ›çé …åªåœéŸ³ä¸æ’­æ”¾ï¼›é€å‡ºã€Œç¬¬ä¸€ä½å¾—çè€…ã€æ‰é–‹å§‹æ’­æ”¾
if (stageUI.audio) {
  const newPrize = st.prize || "";
  const prizeChanged = (newPrize !== playingPrize);

  // å…ˆåˆ¤æ–· winnersï¼ˆé€™æ¬¡èˆå°ç‹€æ…‹ï¼‰
  const list = Array.isArray(st.winners) ? st.winners : [];
  const hasAnyWinner = list.length > 0;

  if (prizeChanged) {
    // æ›çé …ï¼šæ›´æ–° playingPrizeï¼Œé‡ç½®å•Ÿå‹•æ——æ¨™ï¼ŒåœéŸ³ï¼ˆä¸è‡ªå‹•æ’­æ”¾ï¼‰
    playingPrize = newPrize;
    audioStartedForCurrentPrize = false;
    stopAudio();
  }

  // è‹¥æ­¤çé …å·²ç¶“å‡ºç¾ç¬¬ä¸€ä½å¾—çè€…ï¼Œä¸”å°šæœªå•Ÿå‹•ééŸ³æ•ˆ => é–‹å§‹æ’­æ”¾
  if (!state.audioMuted && playingPrize && hasAnyWinner && !audioStartedForCurrentPrize) {
    const ok = await startLoopAudio();
    if (ok) audioStartedForCurrentPrize = true;
  }

  // è‹¥ç›®å‰æ²’æœ‰å¾—çè€…ï¼ˆä¾‹å¦‚åˆ‡æ›çé …/æ¸…ç©ºï¼‰ï¼Œå°±ç¢ºä¿ä¸åœ¨æ’­
  if (!hasAnyWinner) {
    stopAudio();
  }
}

    syncStageWinnersIncremental(st);
  };

  const renderStage = () => {
    const app = document.getElementById("app");
    app.innerHTML = "";
    const st = state.stageState || { prize:"", winners:[], updatedAt:0 };

    const top = el("div", { class:"stageTop" },
      el("div", { class:"stageTitle" }, "ä¸­è¯é›»ä¿¡å­¸é™¢å¹´çµ‚æ„Ÿæ©é¤æœƒæŠ½çæ‘¸å½©æ´»å‹•")
    );

    const prizeTitle = el("div", { class:"bigPrizeTitle", id:"stagePrizeTitle" }, "");
    const prizeDesc  = el("div", { class:"bigPrizeDesc",  id:"stagePrizeDesc"  }, "");
    const prizeWrap  = el("div", { class:"bigPrizeWrap", id:"stagePrizeWrap" }, prizeTitle, prizeDesc);

    const winners = el("div", { class:"bigWinners", id:"stageWinners" });
    const flash = el("div", { class:"stageFlash", id:"stageFlash" });
    const audio = el("audio", { id:"stageAudio", preload:"auto", src:"æŠ½çç·Šå¼µé…æ¨‚.mp3" });

    const audioBtn = el("button", { onclick: toggleMute, type:"button", "aria-pressed":"false" }, "ğŸ”Š");
    const audioToggle = el("div", { class:"audioToggle" }, audioBtn);

    const stageCard = el("div", { class:"stageCard" },
      audioToggle,
      flash,
      top,
      prizeWrap,
      winners,
      audio
    );

    app.appendChild(el("div", { class:"stage" }, stageCard));

    stageUI = { prizeTitle, prizeDesc, winners, flash, audio, audioBtn };

    audio.muted = !!state.audioMuted;
    updateAudioBtn();

    setStagePrize(st.prize || "");

    stageRenderedPrize = st.prize || "";
    stageRenderedCount = 0;
    stageRenderedKeys = [];
    syncStageWinnersIncremental(st);

    playingPrize = st.prize || "";
    if (!state.audioMuted && playingPrize){
      startLoopAudio();
    }

    announceStageAnimated(st);
  };

  /* =======================
     Admin view
     ======================= */

  const rebuildStageFromHistory = () => {
    const hist = Array.isArray(state.history) ? state.history : [];
    if (!hist.length){
      state.stageState = { prize:"", winners:[], updatedAt: 0 };
      return;
    }

    const last = hist[hist.length - 1];
    const prize = last?.prize || "";

    const winnersRev = [];
    for (let i = hist.length - 1; i >= 0; i--){
      const r = hist[i];
      if (!r || r.prize !== prize) break;
      const ws = Array.isArray(r.winners) ? r.winners : [];
      for (const w of ws) winnersRev.push({ id: w.id || "", name: w.name || "" });
    }
    winnersRev.reverse();

    state.stageState = { prize, winners: winnersRev, updatedAt: Date.now() };
  };

  // âœ… æ ¸å¿ƒï¼šå¾Œå°åˆ‡æ›çé …æ™‚ï¼Œç«‹åˆ»åŒæ­¥åˆ°èˆå°ï¼ˆæ›´è²¼è¿‘å¯¦éš›æµç¨‹ï¼‰
  // - åˆ‡æ›åˆ°æ–°çé …ï¼šèˆå°é¡¯ç¤ºæ–°çé …ï¼Œæ¸…ç©ºå¾—çè€…ï¼Œä¸¦è§¸ç™¼å‹•ç•«/éŸ³æ•ˆé‡ç½®
  // - è‹¥åŒçé …é‡é¸ï¼šä¸é‡ç½®ï¼ˆé¿å…èª¤æ¸…ç©ºï¼‰
  const pushSelectedPrizeToStage = (prizeValue) => {
    const prize = normalize(prizeValue);
    const prevPrize = state.stageState?.prize || "";

    if (!prize) return;

    // åŒçé …å°±ä¸åšäº‹ï¼ˆé¿å…ä¸å°å¿ƒæ¸…ç©ºï¼‰
    if (prevPrize === prize) return;

    const ts = Date.now();
    state.stageState = { prize, winners: [], updatedAt: ts };
    saveAll();

    // å…ˆæç¤ºèˆå°åœä¸€ä¸‹éŸ³æ¨‚ï¼ˆé¿å…åœ¨æ›çé …æ™‚éŸ³æ¨‚äº‚è·³ï¼‰
    post("prize_selected", { prize });

    // å†é€å‡ºçœŸæ­£çš„èˆå°ç‹€æ…‹æ›´æ–°ï¼ˆè®“å‰å°ç«‹å³æ›´æ–°çé …/æ¸…ç©ºå¾—çè€…ï¼‰
    post("update_stage", state.stageState);
  };

  const renderAdmin = () => {
    const app = document.getElementById("app");
    app.innerHTML = "";

    const openStage = () => {
      const url = new URL(location.href);
      url.searchParams.set("stage","1");
      window.open(url.toString(), "stage_screen");
    };

    const importParticipantsFile = async (file) => {
      const text = await file.text();
      const { header, rows } = parseCSV(text);

      const h = header.map(x => normalize(x));
      const colId = h.findIndex(x => ["åºè™Ÿ","ç·¨è™Ÿ","id","ID","No","NO","no"].includes(x));
      const colName = h.findIndex(x => ["å§“å","name","Name","NAME"].includes(x));

      const list = [];
      for (const r of rows){
        if (!r.length) continue;
        let id = "", name = "";
        if (colName >= 0 && colId >= 0){
          id = padId(r[colId] ?? "");
          name = normalize(r[colName] ?? "");
        } else if (colName >= 0){
          name = normalize(r[colName] ?? "");
        } else if (r.length >= 2){
          id = padId(r[0] ?? "");
          name = normalize(r[1] ?? "");
        } else {
          name = normalize(r[0] ?? "");
        }
        if (id || name) list.push({ id, name });
      }

      state.participants = list;
      state.index = buildIndex(state.participants);
      saveAll();
      post("sync", {});
      alert(`å·²åŒ¯å…¥åå–®ï¼š${state.participants.length} ç­†`);
      renderAdmin();
    };

    const importPrizesFile = async (file) => {
      const text = await file.text();
      const { header, rows } = parseCSV(text);
      const h = header.map(x => normalize(x));
      const colPrize = h.findIndex(x => ["çé …","çé …åç¨±","prize","Prize","name","åç¨±"].includes(x));
      const list = [];

      for (const r of rows){
        let title = "";
        if (colPrize >= 0) title = normalize(r[colPrize] ?? "");
        else title = normalize(r[0] ?? "");

        const desc = normalize(r[1] ?? "");
        const value = desc ? `${title}\n${desc}` : title;

        if (normalize(value)) list.push(value);
      }

      state.prizes = list;
      saveAll();
      post("sync", {});
      alert(`å·²åŒ¯å…¥çé …ï¼š${state.prizes.length} å€‹`);
      renderAdmin();
    };

    const addOneDraw = (prize, winner, warnings=[]) => {
      const ts = Date.now();

      const prevPrize = state.stageState?.prize || "";
      const prevWinners = Array.isArray(state.stageState?.winners) ? state.stageState.winners : [];

      let nextWinners = [];
      if (prevPrize && prevPrize === prize) nextWinners = [...prevWinners];
      else nextWinners = [];

      nextWinners.push({ id: winner.id || "", name: winner.name || "" });

      state.stageState = { prize, winners: nextWinners, updatedAt: ts };

      state.history.push({
        ts,
        prize,
        winners: [{ id: winner.id || "", name: winner.name || "" }],
        warnings
      });

      saveAll();
      post("update_stage", state.stageState);
      post("update_history", state.history);
    };

    const undoLast = () => {
      if (!state.history.length){
        alert("ç›®å‰æ²’æœ‰å¯ä»¥å›é€€çš„ç´€éŒ„");
        return;
      }
      const last = state.history[state.history.length - 1];
      const lastInfo = `${last.prize} / ${(last.winners?.[0]?.id || "--")} ${(last.winners?.[0]?.name || "")}`.trim();

      if (!confirm(`ç¢ºå®šè¦å›é€€ä¸Šä¸€æŠ½ï¼Ÿ\n\n${lastInfo}\n\nï¼ˆå°‡åŒæ­¥æ›´æ–°èˆå°ç•«é¢èˆ‡æ­·å²ç´€éŒ„ï¼‰`)) return;

      state.history.pop();
      rebuildStageFromHistory();
      saveAll();

      post("update_stage", state.stageState);
      post("update_history", state.history);

      renderAdmin();
    };

    const exportHistory = () => {
      const lines = [];
      lines.push(["æ™‚é–“","çé …","å¾—çåºè™Ÿ","å¾—çå§“å","å‚™è¨»"].map(escapeCSV).join(","));
      for (const r of state.history){
        const winners = r.winners || [];
        const warn = (r.warnings || []).join(" | ");
        if (!winners.length){
          lines.push([fmtTime(r.ts), r.prize, "", "", warn].map(escapeCSV).join(","));
        } else {
          for (const w of winners){
            lines.push([fmtTime(r.ts), r.prize, w.id || "", w.name || "", warn].map(escapeCSV).join(","));
          }
        }
      }
      const filename = `å¾—çæ­·å²_${new Date().toISOString().slice(0,10)}.csv`;
      downloadText(filename, lines.join("\n"));
    };

    const clearHistory = () => {
      if (!confirm("ç¢ºå®šè¦æ¸…ç©ºå¾—çæ­·å²ï¼Ÿï¼ˆç„¡æ³•å¾©åŸï¼‰")) return;
      state.history = [];
      state.stageState = { prize:"", winners:[], updatedAt:0 };
      saveAll();
      post("update_stage", state.stageState);
      post("update_history", state.history);
      renderAdmin();
    };

    const submitManual = () => {
      const prize = normalize(document.getElementById("prizeSel").value);
      const input = normalize(document.getElementById("winnerInput").value);

      if (!prize){
        alert("è«‹å…ˆé¸æ“‡çé …");
        return;
      }
      if (!input){
        alert("è«‹è¼¸å…¥å¾—çè€…ï¼ˆåºè™Ÿæˆ–å§“åï¼‰");
        return;
      }

      const rawTokens = input.split(/[,ï¼Œ\n\t ]+/).map(t => normalize(t)).filter(Boolean);
      if (!rawTokens.length){
        alert("è«‹è¼¸å…¥å¾—çè€…ï¼ˆåºè™Ÿæˆ–å§“åï¼‰");
        return;
      }

      const warnings = [];
      if (rawTokens.length > 1){
        warnings.push(`ä¸€æ¬¡è¼¸å…¥å¤šç­†å·²åµæ¸¬åˆ° ${rawTokens.length} ç­†ï¼›ç‚ºç¬¦åˆé€ä¸€æŠ½çï¼Œæœ¬æ¬¡åƒ…é€å‡ºç¬¬ä¸€ç­†ï¼š${rawTokens[0]}`);
      }

      const token = rawTokens[0];
      const r = resolveToken(token);
      if (!r.ok){
        alert(`${token}: ${r.reason}`);
        return;
      }
      if (r.note) warnings.push(`${token}: ${r.note}`);

      state.uiSelectedPrize = prize;
      saveAll();

      addOneDraw(prize, { id: r.id || "", name: r.name || "" }, warnings);

      document.getElementById("winnerInput").value = "";
      document.getElementById("resolvePreview").innerHTML = "";

      renderAdmin();
      setTimeout(() => document.getElementById("winnerInput")?.focus(), 0);
    };

    const previewResolve = () => {
      const input = normalize(document.getElementById("winnerInput").value);
      const box = document.getElementById("resolvePreview");
      if (!input){ box.innerHTML = ""; return; }
      const rawTokens = input.split(/[,ï¼Œ\n\t ]+/).map(t => normalize(t)).filter(Boolean);

      const ok = [];
      const bad = [];
      for (const t of rawTokens){
        const r = resolveToken(t);
        if (r.ok) ok.push(r);
        else bad.push(r);
      }

      const parts = [];
      if (rawTokens.length > 1){
        parts.push(`<div class="warnbox">âš ï¸ å»ºè­°ä¸€æ¬¡åªè¼¸å…¥ 1 ä½ï¼ˆé€ä¸€æŠ½çé€ä¸€å…¬å¸ƒï¼‰ã€‚æœ¬æ¬¡é€å‡ºæœƒåªå–ç¬¬ä¸€ç­†ï¼š<span class="mono">${rawTokens[0]}</span></div>`);
      }
      if (ok.length){
        parts.push(`<div class="small" style="margin-top:8px">å¯é…å°ï¼š</div>`);
        parts.push(`<div style="margin-top:6px; line-height:1.7;">${
          ok.map((x, idx) => {
            const extra = (idx === 0) ? ` <span class="pill"><strong>æœ¬æ¬¡é€å‡º</strong></span>` : "";
            return `<span class="pill"><strong class="mono">${(x.id||"--")}</strong> ${x.name||""}</span>${extra}`;
          }).join(" ")
        }</div>`);
      }
      if (bad.length){
        parts.push(`<div style="margin-top:10px" class="small">ç„¡æ³•é…å°ï¼š</div>`);
        parts.push(`<div style="margin-top:6px" class="warnbox">${
          bad.map(x => `â€¢ <span class="mono">${x.raw}</span>ï¼š${x.reason}`).join("<br>")
        }</div>`);
      }
      box.innerHTML = parts.join("");
    };

    const countP = state.participants.length;
    const countPr = state.prizes.length;

    const left = el("div", { class:"card" },
      el("h1", {}, "ä¸­è¯é›»ä¿¡å­¸é™¢å¹´çµ‚æ„Ÿæ©é¤æœƒ-å¯¦é«”æŠ½çå¾Œæ‰‹å‹•ç™»è¨˜é¡¯ç¤ºå¾—çè€…è³‡è¨Š"),
      el("div", { class:"row" },
        el("span", { class:"pill" }, "åå–®ï¼š", el("strong", {}, `${countP} ç­†`)),
        el("span", { class:"pill" }, "çé …ï¼š", el("strong", {}, `${countPr} å€‹`)),
        el("span", { class:"pill" }, "æ­·å²ï¼š", el("strong", {}, `${state.history.length} ç­†`)),
        el("button", { onclick: openStage }, "é–‹å•Ÿèˆå°ç•«é¢ï¼ˆæŠ•å½±ç”¨ï¼‰")
      ),
      el("div", { class:"divider" }),

      el("h2", {}, "1) åŒ¯å…¥è³‡æ–™ï¼ˆå¯ç”¨ CSVï¼‰"),

      el("label", {}, "åƒèˆ‡è€…åå–® CSVï¼ˆæ”¯æ´ï¼šåºè™Ÿ,å§“å æˆ– åªæœ‰å§“åï¼‰"),
      el("div", { class:"row" },
        el("input", { id:"pFile", type:"file", accept:".csv,text/csv" }),
        el("button", {
          onclick: () => {
            const f = document.getElementById("pFile").files?.[0];
            if (!f) return alert("è«‹å…ˆé¸æ“‡åå–® CSV æª”");
            importParticipantsFile(f);
          }
        }, "åŒ¯å…¥åå–®")
      ),
      el("div", { class:"hint" }, "CSV ç¬¬ä¸€åˆ—å¯æœ‰æ¨™é¡Œï¼šåºè™Ÿ,å§“åã€‚ä¹Ÿå¯ç›´æ¥å…©æ¬„æˆ–å–®æ¬„ã€‚"),

      el("label", {}, "çé … CSVï¼ˆæ”¯æ´å…©æ¬„ï¼šçé …,å…§å®¹ï¼›ä¹Ÿæ”¯æ´å–®æ¬„ï¼‰"),
      el("div", { class:"row" },
        el("input", { id:"prFile", type:"file", accept:".csv,text/csv" }),
        el("button", {
          onclick: () => {
            const f = document.getElementById("prFile").files?.[0];
            if (!f) return alert("è«‹å…ˆé¸æ“‡çé … CSV æª”");
            importPrizesFile(f);
          }
        }, "åŒ¯å…¥çé …")
      ),

      el("div", { class:"divider" }),

      el("h2", {}, "2) ç™»è¨˜å¾—çè€…ï¼ˆé€ä¸€æŠ½çé€ä¸€å…¬å¸ƒï¼‰"),

      el("label", {}, "çé …ï¼ˆåˆ‡æ›å¾Œæœƒç«‹åˆ»åŒæ­¥åˆ°èˆå°ï¼Œä¸¦æ¸…ç©ºèˆå°å¾—çè€…ï¼Œæº–å‚™ä¸‹ä¸€æŠ½ï¼‰"),
      (() => {
        const s = el("select", {
          id:"prizeSel",
          onchange: (e) => {
            state.uiSelectedPrize = normalize(e.target.value);
            saveAll();

            // âœ… é—œéµï¼šå¾Œå°åˆ‡æ›ä¸‹æ‹‰ => å‰å°èˆå°åŒæ­¥æ›´æ–°çé …
            pushSelectedPrizeToStage(state.uiSelectedPrize);
          }
        },
          el("option", { value:"" }, "â€” è«‹é¸æ“‡çé … â€”"),
          ...state.prizes.map(v => {
            const { title, desc } = splitPrize(v);
            const label = desc ? `${title}ï¼ˆ${desc}ï¼‰` : title;
            return el("option", { value:v }, label);
          })
        );
        setTimeout(() => { s.value = state.uiSelectedPrize || ""; }, 0);
        return s;
      })(),

      el("label", {}, "å¾—çè€…ï¼ˆå»ºè­°ä¸€æ¬¡è¼¸å…¥ 1 ä½ï¼šåºè™Ÿ / å§“å / éƒ¨åˆ†å§“åï¼‰"),
      el("input", {
        id:"winnerInput",
        type:"text",
        placeholder:'ä¾‹å¦‚ï¼š013 æˆ– ç‹å°æ˜ æˆ– å°æ˜',
        oninput: previewResolve
      }),
      el("div", { id:"resolvePreview", style:"margin-top:10px" }),

      el("div", { class:"row", style:"margin-top:12px" },
        el("button", { class:"ok", onclick: submitManual }, "é€å‡ºï¼ˆå…¬å¸ƒåˆ°èˆå° + å¯«å…¥æ­·å²ï¼‰"),
        el("button", { class:"bad", onclick: undoLast }, "Undoï¼ˆå›é€€ä¸Šä¸€æŠ½ï¼‰"),
        el("button", {
          onclick: () => {
            document.getElementById("winnerInput").value = "";
            document.getElementById("resolvePreview").innerHTML = "";
          }
        }, "æ¸…ç©ºè¼¸å…¥")
      ),

      el("div", { class:"hint" },
        "é…å°è¦å‰‡ï¼šæ•¸å­—è¦–ç‚ºåºè™Ÿï¼›æ–‡å­—å…ˆæ¯”å°å®Œæ•´å§“åï¼Œå†æ¯”å°éƒ¨åˆ†å§“åã€‚è‹¥éƒ¨åˆ†å§“åå‘½ä¸­å¤šäººï¼Œæœƒè¦æ±‚ä½ è¼¸å…¥æ›´å®Œæ•´ã€‚"
      )
    );

    const right = el("div", { class:"card" },
      el("h2", {}, "å¾—çæ­·å²ï¼ˆæœ€æ–°åœ¨å‰ï¼‰"),
      el("div", { class:"row" },
        el("button", { onclick: exportHistory }, "åŒ¯å‡º CSV"),
        el("button", { class:"bad", onclick: clearHistory }, "æ¸…ç©ºæ­·å²")
      ),
      el("div", { class:"hint" }, "åŒ¯å‡ºæ ¼å¼ï¼šæ¯ä½å¾—çè€…ä¸€åˆ—ï¼ˆå«æ™‚é–“ã€çé …ã€åºè™Ÿã€å§“åã€å‚™è¨»ï¼‰ã€‚"),
      el("div", { class:"divider" }),
      (() => {
        const t = el("table", {});
        t.appendChild(el("thead", {}, el("tr", {},
          el("th", {}, "æ™‚é–“"),
          el("th", {}, "çé …"),
          el("th", {}, "å¾—çè€…")
        )));
        const tb = el("tbody", {});
        const list = [...state.history].slice().reverse().slice(0, 50);
        for (const r of list){
          tb.appendChild(el("tr", {},
            el("td", { class:"mono" }, fmtTime(r.ts)),
            el("td", {}, r.prize),
            el("td", {}, (r.winners||[]).map(w => `${w.id || "--"} ${w.name || ""}`.trim()).join("ã€"))
          ));
        }
        if (!list.length){
          tb.appendChild(el("tr", {}, el("td", { colspan:"3", class:"small" }, "å°šç„¡ç´€éŒ„")));
        }
        t.appendChild(tb);
        return t;
      })()
    );

    app.appendChild(el("div", { class:"wrap" }, el("div", { class:"grid" }, left, right)));

    window.onkeydown = (e) => {
      const isMac = /Mac|iPhone|iPad|iPod/.test(navigator.platform);
      const isUndo = (isMac ? e.metaKey : e.ctrlKey) && (e.key === "z" || e.key === "Z");
      if (isUndo){
        const tag = (document.activeElement?.tagName || "").toLowerCase();
        if (tag !== "input" && tag !== "textarea"){
          e.preventDefault();
          undoLast();
        }
      }
    };
  };

  // --- Realtime sync listeners
  const onMessage = (msg) => {
    if (!msg || !msg.type) return;

    state.participants = loadJSON(KEY.participants, state.participants);
    state.prizes       = loadJSON(KEY.prizes, state.prizes);
    state.history      = loadJSON(KEY.history, state.history);
    state.stageState   = loadJSON(KEY.stageState, state.stageState);
    state.uiSelectedPrize = loadJSON("manual_award.uiSelectedPrize.v1", state.uiSelectedPrize);
    state.audioMuted   = loadJSON(KEY.audioMuted, state.audioMuted);
    state.index = buildIndex(state.participants);

    if (isStage){
      if (!stageUI) renderStage();

      if (msg.type === "prize_selected"){
        // åªåšâ€œåˆ‡æ›ç¬é–“â€çš„åœéŸ³ï¼ŒçœŸæ­£ç•«é¢æ›´æ–°é  stageState / updatedAt
        stopAudio();
      }

      // âœ… ä¸ç®¡æ˜¯ update_stage / storage / syncï¼Œéƒ½ä»¥ stageState ç‚ºæº–é€²è¡Œåˆ·æ–°
      announceStageAnimated(state.stageState);

      if (stageUI?.audio){
        stageUI.audio.muted = !!state.audioMuted;
      }
      updateAudioBtn();
    } else {
      renderAdmin();
    }
  };

  if (bc) bc.onmessage = (e) => onMessage(e.data);
  window.addEventListener("storage", (e) => {
    if (e.key === "__manual_award_ping__" ||
        [KEY.participants, KEY.prizes, KEY.history, KEY.stageState, KEY.audioMuted].includes(e.key) ||
        e.key === "manual_award.uiSelectedPrize.v1"){
      onMessage({ type:"storage" });
    }
  });

  // --- Initial render
  if (isStage) renderStage();
  else renderAdmin();
})();
</script>
</body>
</html>
