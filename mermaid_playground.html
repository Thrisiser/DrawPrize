<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mermaid 心智圖／圖表線上產生器</title>
<!-- 載入 Mermaid (使用 CDN) -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<style>
  /* 簡潔排版 */
  :root {
    --bg: #f7f7f9;
    --panel: #ffffff;
    --text: #222;
    --muted: #666;
    --border: #e6e6ef;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; background: var(--bg); color: var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 16px; border-bottom: 1px solid var(--border); background: var(--panel);
    position: sticky; top: 0; z-index: 10;
  }
  header .title { font-weight: 700; }
  header .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  select, button {
    padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; cursor: pointer;
  }
  button.primary { background: #222; color: #fff; border-color: #222; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  main { display: grid; grid-template-columns: 1fr 1.2fr; gap: 12px; padding: 12px; }
  @media (max-width: 1024px) { main { grid-template-columns: 1fr; } }
  .panel {
    background: var(--panel); border: 1px solid var(--border); border-radius: 10px; overflow: hidden;
    display: flex; flex-direction: column; min-height: 320px;
  }
  .panel h3 { margin: 0; padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--muted); }
  .panel .body { padding: 0; display: flex; flex-direction: column; height: 100%; }
  textarea {
    width: 100%; height: 100%; resize: vertical; min-height: 300px; border: 0; padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size: 14px; line-height: 1.5; outline: none;
  }
  .preview-wrap {
    padding: 12px; overflow: auto; height: 100%;
  }
  .hint { padding: 8px 12px; font-size: 12px; color: var(--muted); border-top: 1px dashed var(--border); }
  .error {
    padding: 10px 12px; color: #b00020; background: #fff2f4; border-top: 1px solid #ffdbe2; font-family: ui-monospace, monospace; white-space: pre-wrap;
  }
  .footer {
    display: flex; gap: 8px; align-items: center; justify-content: flex-end; padding: 10px 12px; border-top: 1px solid var(--border);
    background: #fafafa;
  }
</style>
</head>
<body>
  <header>
    <div class="title">Mermaid Playground（含心智圖）</div>
    <div class="controls">
      <label>主題：
        <select id="theme">
          <option value="default">default</option>
          <option value="dark">dark</option>
          <option value="forest">forest</option>
          <option value="neutral">neutral</option>
        </select>
      </label>
      <label>安全模式：
        <select id="security">
          <option value="strict">strict（預設）</option>
          <option value="loose">loose</option>
          <option value="antiscript">antiscript</option>
        </select>
      </label>
      <button id="btnRender" class="primary">重新渲染</button>
      <button id="btnSVG">下載 SVG</button>
      <button id="btnPNG">下載 PNG</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <h3>輸入 Mermaid 語法</h3>
      <div class="body">
        <textarea id="input"></textarea>
        <div class="hint">
          小提醒：支援 <code>flowchart / sequence / class / state / er / gantt / journey / pie / requirement-diagram / gitGraph / mindmap</code> 等。<br/>
          你也可以貼上含有 <code>```mermaid ... ```</code> 的區塊，會自動去掉外圍語法。
        </div>
      </div>
    </section>

    <section class="panel">
      <h3>預覽</h3>
      <div class="body">
        <div id="preview" class="preview-wrap">
          <!-- render output here -->
        </div>
        <div id="error" class="error" style="display:none;"></div>
        <div class="footer">
          <small id="status" class="hint" style="border:0;padding:0;"></small>
        </div>
      </div>
    </section>
  </main>

<script>
/* =========================
   預設內容（心智圖示範）
   ========================= */
const DEFAULT_MINDMAP = `
%% mindmap: Mermaid v10+ 支援
mindmap
  root((企業培訓課程設計))
    目標對齊
      業務績效
      客訓NPS
      內訓滿意度
    教學法
      PBL
      Flipped
      微課/任務制
    工具
      AI 輔助
        Prompt 設計
        自動評量
      習慣追蹤
    產出驗收
      前後測
      行為觀察
      成果發表
`.trim();

/* =========================
   Mermaid 初始化
   ========================= */
let mermaidInitialized = false;
function initMermaid(theme = 'default', security = 'strict') {
  mermaid.initialize({
    startOnLoad: false,
    theme,
    securityLevel: security, // 嚴格建議用 strict，避免 XSS
    flowchart: { htmlLabels: true },
    mindmap: { // 心智圖的實驗性配置（Mermaid 10+）
      padding: 12
    },
    er: { },
    sequence: { },
    // 想調其他類型可加在這裡
  });
  mermaidInitialized = true;
}

/* =========================
   工具：處理 ```mermaid 區塊
   ========================= */
function normalizeInput(src) {
  // 去掉 ```mermaid ... ``` 外殼
  const fence = /```(?:mermaid)?\s*([\s\S]*?)\s*```/i;
  const m = src.match(fence);
  return m ? m[1].trim() : src.trim();
}

/* =========================
   渲染邏輯（含驗證、錯誤處理）
   ========================= */
const $input = document.getElementById('input');
const $preview = document.getElementById('preview');
const $error = document.getElementById('error');
const $status = document.getElementById('status');
const $theme = document.getElementById('theme');
const $security = document.getElementById('security');
const $btnRender = document.getElementById('btnRender');
const $btnSVG = document.getElementById('btnSVG');
const $btnPNG = document.getElementById('btnPNG');

function setStatus(text) { $status.textContent = text || ''; }
function showError(msg) {
  $error.style.display = 'block';
  $error.textContent = String(msg);
}
function clearError() { $error.style.display = 'none'; $error.textContent = ''; }

async function render() {
  try {
    clearError();
    setStatus('渲染中…');
    if (!mermaidInitialized) {
      initMermaid($theme.value, $security.value);
    } else {
      // 變更主題/安全層級時重新初始化
      initMermaid($theme.value, $security.value);
    }

    const code = normalizeInput($input.value);
    // 先驗證語法（會丟錯誤）
    await mermaid.parse(code);

    // 用 render API 產出 SVG
    const { svg } = await mermaid.render('mermaid-' + Date.now(), code);
    $preview.innerHTML = svg;
    setStatus('完成 ✓');
  } catch (err) {
    showError(err?.message || err);
    $preview.innerHTML = '';
    setStatus('失敗');
  }
}

/* =========================
   匯出：下載 SVG / PNG
   ========================= */
function download(filename, blob) {
  const a = document.createElement('a');
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function exportSVG() {
  const svgEl = $preview.querySelector('svg');
  if (!svgEl) return;
  const svgText = new XMLSerializer().serializeToString(svgEl);
  const blob = new Blob([svgText], { type: 'image/svg+xml;charset=utf-8' });
  download('diagram.svg', blob);
}

// 將 SVG 轉 PNG（透過 <canvas>）
    function exportPNG() {
  const svgEl = $preview.querySelector('svg');
  if (!svgEl) return;

  // 取出 SVG 原始碼
  const svgText = new XMLSerializer().serializeToString(svgEl);
  const svgBlob = new Blob([svgText], { type: 'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(svgBlob);

  // 解析 viewBox，取得真實大小
  let width = 800, height = 600; // 預設值
  if (svgEl.viewBox && svgEl.viewBox.baseVal) {
    width = svgEl.viewBox.baseVal.width;
    height = svgEl.viewBox.baseVal.height;
  } else {
    width = svgEl.getAttribute('width') || width;
    height = svgEl.getAttribute('height') || height;
  }

  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = () => {
    const scale = 2; // 輸出放大倍數
    const canvas = document.createElement('canvas');
    canvas.width = width * scale;
    canvas.height = height * scale;
    const ctx = canvas.getContext('2d');
    ctx.setTransform(scale, 0, 0, scale, 0, 0);
    ctx.drawImage(img, 0, 0, width, height);
    canvas.toBlob((blob) => {
      if (blob) download('diagram.png', blob);
      URL.revokeObjectURL(url);
    }, 'image/png');
  };
  img.onerror = () => {
    alert('無法匯出 PNG，請改存 SVG。');
    URL.revokeObjectURL(url);
  };
  img.src = url;
}


/* =========================
   事件：自動儲存、即時預覽
   ========================= */
let debounceTimer = null;
function scheduleRender() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(render, 400);
}

// 儲存到 localStorage（方便你回來續編）
const LS_KEY = 'mermaid.playground.input';
function loadFromLS() {
  const saved = localStorage.getItem(LS_KEY);
  $input.value = saved || DEFAULT_MINDMAP;
}
function saveToLS() {
  localStorage.setItem(LS_KEY, $input.value);
}

// 綁定事件
$input.addEventListener('input', () => { saveToLS(); scheduleRender(); });
$theme.addEventListener('change', render);
$security.addEventListener('change', render);
$btnRender.addEventListener('click', render);
$btnSVG.addEventListener('click', exportSVG);
$btnPNG.addEventListener('click', exportPNG);

// 初始載入
loadFromLS();
render();
</script>
</body>
</html>
